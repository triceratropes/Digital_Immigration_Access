<!-- initially from: https://gist.github.com/cbosco/4626891 -->
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Photos with Friends!</title>
        <script src="jquery-1.9.0.js"></script>
        <script src="https://socket.memoryarchive.net/socket.io/socket.io.js"></script>
        <script src="https://cdn.jsdelivr.net/jquery.validation/1.15.0/jquery.validate.min.js"></script>
        <script src="https://cdn.jsdelivr.net/jquery.validation/1.15.0/additional-methods.min.js"></script>
        <link rel="stylesheet" href="reset.css">
        <link rel="stylesheet" href="styles.css">
        <meta name="viewport" content="initial-scale=1">
    </head>

    <body>
        <svg class="hideSvgFilter" xmlns="http://www.w3.org/2000/svg" version="1.1">
            <defs>
                <filter id="glitch" x="0" y="0">
                    <feColorMatrix in="SourceGraphic" mode="matrix" values="1 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 1 0" result="r" />
                    <feOffset in="r" result="r" dx="-5">
                    <animate attributeName="dx" attributeType="XML" values="0; -5; 0; -18; -2; -4; 0 ;-3; 0" dur="0.2s" repeatCount="indefinite"/>
                    </feOffset>
                    <feColorMatrix in="SourceGraphic" mode="matrix" values="0 0 0 0 0  0 1 0 0 0  0 0 0 0 0  0 0 0 1 0" result="g"/>
                    <feOffset in="g" result="g" dx="-5" dy="1">
                    <animate attributeName="dx" attributeType="XML" values="0; 0; 0; -3; 0; 8; 0 ;-1; 0" dur="0.15s" repeatCount="indefinite"/>
                    </feOffset>
                    <feColorMatrix in="SourceGraphic" mode="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 1 0 0  0 0 0 1 0" result="b"/>
                    <feOffset in="b" result="b" dx="5" dy="2">
                    <animate attributeName="dx" attributeType="XML" values="0; 3; -1; 4; 0; 2; 0 ;18; 0" dur="0.35s" repeatCount="indefinite"/>
                    </feOffset>
                    <feBlend in="r" in2="g" mode="screen" result="blend" />
                    <feBlend in="blend" in2="b" mode="screen" result="blend" />
                </filter>
            </defs>
        </svg>

        <svg class="hideSvgFilter" xmlns="http://www.w3.org/2000/svg" version="1.1">
            <defs>
                <filter id="rgbGlitch" x="0" y="0">
                    <feColorMatrix in="SourceGraphic" mode="matrix" values="1 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 1 0" result="r" />
                    <feOffset in="r" result="r" dx="-5">
                    <animate attributeName="dx" attributeType="XML" values="0; -1; 0; -6; -0.75; -1.3; 0 ;-0.1; 0" dur="0.6" repeatCount="indefinite"/>
                    </feOffset>
                    <feColorMatrix in="SourceGraphic" mode="matrix" values="0 0 0 0 0  0 1 0 0 0  0 0 0 0 0  0 0 0 1 0" result="g"/>
                    <feOffset in="g" result="g" dx="-5" dy="1">
                    <animate attributeName="dx" attributeType="XML" values="0; 0; 0; -1; 0; 5; 0 ;0; 0" dur="0.3s" repeatCount="indefinite"/>
                    </feOffset>
                    <feColorMatrix in="SourceGraphic" mode="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 1 0 0  0 0 0 1 0" result="b"/>
                    <feOffset in="b" result="b" dx="5" dy="2">
                    <animate attributeName="dx" attributeType="XML" values="0; 3; -3; 3; 0; 3; 0 ; 18; 0" dur="0.6s" repeatCount="indefinite"/>
                    </feOffset>
                    <feBlend in="r" in2="g" mode="screen" result="blend" />
                    <feBlend in="blend" in2="b" mode="screen" result="blend" />
                </filter>
            </defs>
        </svg>

        <div class="intro-div">
            Welcome to the
            <!-- <div class="header example&#45;one" data&#45;text="memory_archive"> -->
            <!--     memory_archive -->
            <!-- </div> -->
            <br>
            <div class="header text2">
                memory_archive
            </div>
            <!-- <br> -->
            <!-- <div class="header text"> -->
            <!--     memory_archive -->
            <!-- </div> -->
            <div class="intro-text">
                Warning: this show has flashing lights, and
                <br>
                intense (sometimes disturbing content.) By logging into Facebook
                <br>
                below, you are giving us permission to access your
                <br>
                posted photos, which we will be using for the exhibit.
                <br>
                If you have any questions about the usage of this data, see our
                <br>
                <a href="/privacyPolicy.html">privacy policy</a>.
                Thank you for your participation, and please
                <br>
                move along.
            </div>
        </div>

        <h1>Proceed when the following checkboxes are checked.</h1>
        <div>
            <ul>
                <div>
                    <input name="twilio-checkbox" type="checkbox" class="display-none" disabled>
                    <label for="twilio-checkbox">Phone number submitted</label>
                </div>
                <div>
                    <input name="fb-logged-in" type="checkbox" class="display-none" disabled>
                    <label for="fb-logged-in">Logged into Facebook on this page.</label>
                </div>
            </ul>
        </div>
        <div id="twilio-box">
            <form id="twilio-form">
                <label for="telNum">Enter your phone number:</label>
                <input type="tel" name="telNum" id="twilio-number-input">
                <button type="submit">Submit</button>
                <br>
                <label for="telNum-opt-out">Or, if you don't want to provide us with your phone number, hit this checkbox:</label>
                <input type="checkbox" name="telNum-opt-out" id="twilio-number-opt-out">
            </form>
        </div>
        <div id="photos"></div>
        <div id="facebook-group">
            <div id="fb-root"></div>
            <div class="fb-login-button" data-max-rows="1" data-size="medium" data-show-faces="true" data-auto-logout-link="true" data-scope="user_photos" onlogin="checkLogin()"></div>

                <br>
                <label for="fb-root-opt-out">Or, if you don't want to log in to Facebook, hit this checkbox:</label>
                <input type="checkbox" name="fb-root-opt-out" id="fb-opt-out">
        </div>
        <script>
            // wait for DOM, facebook auth, and socket connection
            var docReady = $.Deferred();
            $(document).ready(docReady.resolve);

            var  accessToken    =  null;
            var  receivedToken  =  $.Deferred();
            var  uid            =  null;
            var  number         =  window.localStorage.number;

            $.when(docReady).then(function () {
                if (number) emitHide()
            })

            var facebookReady = $.Deferred();
            window.fbAsyncInit = function() {
                FB.init({
                    appId      : '1391443554220655',
                    cookie     : true,
                    xfbml      : true,
                    version    : 'v2.8'
                });
                facebookReady.resolve();
                checkLogin()
            };

            var socketReady = $.Deferred();
            var socket = io('https://socket.memoryarchive.net/');
            socket.on('connect', function() {
                socket.on('photos', function (photos) {
                    receivedToken.then(function () {
                        photos.forEach(function (photo) {
                            $('#photos').prepend(makeImage(photo, 100, 100));
                        });
                    })
                });
                socketReady.resolve();
            });

            $.when(docReady, socketReady, receivedToken).then(function () {
                console.log('socket ready and received fb token')
                getPhotos(function (photos) {
                    photos.map(function (photo) {
                        return makeFacebookPhotoURL(photo, accessToken);
                    })
                    socket.emit('photos', getRandom(photos, 10));
                });
            });

            // call facebook script
            (function(d){
                var js, id = 'facebook-jssdk'; if (d.getElementById(id)) {return;}
                js = d.createElement('script'); js.id = id; js.async = true;
                js.src = "https://connect.facebook.net/en_US/all.js";
                d.getElementsByTagName('head')[0].appendChild(js);
            }(document));

            // http://stackoverflow.com/questions/19269545/how-to-get-n-no-elements-randomly-from-an-array
            function getRandom(arr, n) {
                var result = new Array(n),
                    len = arr.length,
                    taken = new Array(len);
                if (n > len)
                    throw new RangeError("getRandom: more elements taken than available");
                while (n--) {
                    var x = Math.floor(Math.random() * len);
                    result[n] = arr[x in taken ? taken[x] : x];
                    taken[x] = --len;
                }
                return result;
            }

            function makeImage(src, height, width) {
                var newImg = new Image(height, width);
                newImg.src = src;
                return newImg;
            }

            function checkLogin () {
                if (!accessToken) {
                    FB.getLoginStatus(function(response) {
                        if (response.status === 'connected') {
                            accessToken = response.authResponse.accessToken;
                            uid = response.authResponse.userID;
                            receivedToken.resolve();
                            socket.emit('uid', uid);
                            changeCheckbox('[name="fb-logged-in"]', true)
                            $('#facebook-group').hide();
                        }
                    })
                }
            }

            /**
            * This is the getPhoto library
            */
            function makeFacebookPhotoURL( id, accessToken ) {
                return 'https://graph.facebook.com/' + id + '/picture?access_token=' + accessToken;
            }
            function getAlbums( callback ) {
                FB.api(
                    '/me/albums',
                    {fields: 'id,cover_photo'},
                    function(albumResponse) {
                        //console.log( ' got albums ' );
                        if (callback) {
                            callback(albumResponse);
                        }
                    }
                );
            }
            function getPhotosForAlbumId( albumId, callback ) {
                FB.api(
                    '/'+albumId+'/photos',
                    {fields: 'id'},
                    function(albumPhotosResponse) {
                        //console.log( ' got photos for album ' + albumId );
                        if (callback) {
                            callback( albumId, albumPhotosResponse );
                        }
                    }
                );
            }
            function getLikesForPhotoId( photoId, callback ) {
                FB.api(
                    '/'+albumId+'/photos/'+photoId+'/likes',
                    {},
                    function(photoLikesResponse) {
                        if (callback) {
                            callback( photoId, photoLikesResponse );
                        }
                    }
                );
            }
            function getPhotos(callback) {
                var allPhotos = [];
                getAlbums(function(albumResponse) {
                    var i, album, deferreds = {}, listOfDeferreds = [];
                    for (i = 0; i < albumResponse.data.length; i++) {
                        album = albumResponse.data[i];
                        deferreds[album.id] = $.Deferred();
                        listOfDeferreds.push( deferreds[album.id] );
                        getPhotosForAlbumId( album.id, function( albumId, albumPhotosResponse ) {
                            var i, facebookPhoto;
                            for (i = 0; i < albumPhotosResponse.data.length; i++) {
                                facebookPhoto = albumPhotosResponse.data[i];
                                allPhotos.push(makeFacebookPhotoURL( facebookPhoto.id, accessToken ));
                            }
                            deferreds[albumId].resolve();
                        });
                    }
                    $.when.apply($, listOfDeferreds ).then( function() {
                        if (callback) {
                            callback( allPhotos );
                        }
                    }, function( error ) {
                        if (callback) {
                            callback( allPhotos, error );
                        }
                    });
                });
            }
        $( "#twilio-form" ).validate({
            debug: true,
            rules: {
                telNum: {
                    required: true,
                    phoneUS: true
                }
            },
            submitHandler: function() {
                if (!number) {
                    number = document.querySelector('#twilio-number-input').value;
                    window.localStorage.setItem('number', number);
                    changeCheckbox("[name=twilio-checkbox]", true);
                    emitHide();
                }
            }
        });

        function changeCheckbox(query, boolean) {
            document.querySelector(query).checked = boolean;
        }
        $("#twilio-form").submit(function(e){
            e.preventDefault();
        });

        function emitHide () {
            socket.emit('number', number)
            $("#twilio-form").hide()
            $('.intro-div').css('margin-bottom', '0')

        }


        $('#twilio-number-opt-out').change(function() {
            if($(this).is(":checked")) {
                var returnVal = confirm("Are you sure?");
                $(this).attr("checked", returnVal);
                console.log(returnVal);
                if (returnVal) {
                    changeCheckbox('[name="twilio-checkbox"]', true);
                    $("#twilio-form").hide()
                }
            }
        });


        $('#fb-opt-out').change(function() {
            if($(this).is(":checked")) {
                var returnVal = confirm("Are you sure?");
                $(this).attr("checked", returnVal);
                console.log(returnVal);
                if (returnVal) {
                    changeCheckbox('[name="fb-logged-in"]', true);
                    $("#facebook-group").hide()
                }
            }
        });
        </script>
    </body>
</html>
