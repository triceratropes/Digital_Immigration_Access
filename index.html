<!-- from: https://gist.github.com/cbosco/4626891 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Photos with Friends!</title>
        <script src="jquery-1.9.0.js"></script>
        <script src="http://ec2-54-198-145-59.compute-1.amazonaws.com/socket.io/socket.io.js"></script>
        <link rel="stylesheet" href="reset.css">
        <link rel="stylesheet" href="styles.css">
        <meta name="viewport" content="initial-scale=1">
    </head>
    <body>
        <svg class="hideSvgFilter" xmlns="http://www.w3.org/2000/svg" version="1.1">
            <defs>
                <filter id="glitch" x="0" y="0">
                    <feColorMatrix in="SourceGraphic" mode="matrix" values="1 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 1 0" result="r" />
                    <feOffset in="r" result="r" dx="-5">
                    <animate attributeName="dx" attributeType="XML" values="0; -5; 0; -18; -2; -4; 0 ;-3; 0" dur="0.2s" repeatCount="indefinite"/>
                    </feOffset>
                    <feColorMatrix in="SourceGraphic" mode="matrix" values="0 0 0 0 0  0 1 0 0 0  0 0 0 0 0  0 0 0 1 0" result="g"/>
                    <feOffset in="g" result="g" dx="-5" dy="1">
                    <animate attributeName="dx" attributeType="XML" values="0; 0; 0; -3; 0; 8; 0 ;-1; 0" dur="0.15s" repeatCount="indefinite"/>
                    </feOffset>
                    <feColorMatrix in="SourceGraphic" mode="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 1 0 0  0 0 0 1 0" result="b"/>
                    <feOffset in="b" result="b" dx="5" dy="2">
                    <animate attributeName="dx" attributeType="XML" values="0; 3; -1; 4; 0; 2; 0 ;18; 0" dur="0.35s" repeatCount="indefinite"/>
                    </feOffset>
                    <feBlend in="r" in2="g" mode="screen" result="blend" />
                    <feBlend in="blend" in2="b" mode="screen" result="blend" />
                </filter>
            </defs>
        </svg>

        <svg class="hideSvgFilter" xmlns="http://www.w3.org/2000/svg" version="1.1">
            <defs>
                <filter id="rgbGlitch" x="0" y="0">
                    <feColorMatrix in="SourceGraphic" mode="matrix" values="1 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 1 0" result="r" />
                    <feOffset in="r" result="r" dx="-5">
                    <animate attributeName="dx" attributeType="XML" values="0; -1; 0; -6; -0.75; -1.3; 0 ;-0.1; 0" dur="0.6" repeatCount="indefinite"/>
                    </feOffset>
                    <feColorMatrix in="SourceGraphic" mode="matrix" values="0 0 0 0 0  0 1 0 0 0  0 0 0 0 0  0 0 0 1 0" result="g"/>
                    <feOffset in="g" result="g" dx="-5" dy="1">
                    <animate attributeName="dx" attributeType="XML" values="0; 0; 0; -1; 0; 5; 0 ;0; 0" dur="0.3s" repeatCount="indefinite"/>
                    </feOffset>
                    <feColorMatrix in="SourceGraphic" mode="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 1 0 0  0 0 0 1 0" result="b"/>
                    <feOffset in="b" result="b" dx="5" dy="2">
                    <animate attributeName="dx" attributeType="XML" values="0; 3; -3; 3; 0; 3; 0 ; 18; 0" dur="0.6s" repeatCount="indefinite"/>
                    </feOffset>
                    <feBlend in="r" in2="g" mode="screen" result="blend" />
                    <feBlend in="blend" in2="b" mode="screen" result="blend" />
                </filter>
            </defs>
        </svg>

        <div class="intro-div">
            Welcome to the
            <!-- <div class="header example&#45;one" data&#45;text="memory_archive"> -->
            <!--     memory_archive -->
            <!-- </div> -->
            <!-- <br> -->
            <!-- <div class="header text2"> -->
            <!--     memory_archive -->
            <!-- </div> -->
            <br>
            <div class="header text">
                memory_archive
            </div>
            <div class="intro-text">
                <flashing lights warning, etc.>
            </div>
        </div>
        <div id="photos"></div>
        <div id="facebook-group">
            <div id="fb-root"></div>
            <div class="fb-login-button" data-max-rows="1" data-size="medium" data-show-faces="true" data-auto-logout-link="true" data-scope="user_photos" onlogin="checkLogin()"></div>
        </div>
        <div id="twilio-box">
            <form id="twilio-form" action="">
                <label for="telNum">Please enter your phone number here:</label>
                <input type="tel" name="telNum" class="twilio-number-input">
                <button>Submit</button>
            </form>
        </div>
        <script>
            // wait for DOM, facebook auth, and socket connection
            var docReady = $.Deferred();
            $(document).ready(docReady.resolve);

            var accessToken = null
            var receivedToken = $.Deferred();

            var facebookReady = $.Deferred();
            window.fbAsyncInit = function() {
                FB.init({
                    appId      : '1391443554220655',
                    cookie     : true, 
                    xfbml      : true, 
                    version    : 'v2.8'
                });
                facebookReady.resolve();
                checkLogin()
            };

            var socketReady = $.Deferred();
            var socket = io('http://ec2-54-198-145-59.compute-1.amazonaws.com');
            socket.on('connect', function() {
                socket.on('photos', function (photos) {
                    photos.forEach(function (photo) {
                        $('#photos').prepend(makeImage(photo, 100, 100));
                    });
                });
                socketReady.resolve();
            });

            $.when(docReady, socketReady, receivedToken).then(function () {
                console.log('socket ready and received fb token')
                getPhotos(function (photos) {
                    photos = photos.map(function (photo) {
                      return photo.split('/')[3]
                    })
                    socket.emit('photos', getRandom(photos, 10));
                });
            });

            // call facebook script
            (function(d){
                var js, id = 'facebook-jssdk'; if (d.getElementById(id)) {return;}
                js = d.createElement('script'); js.id = id; js.async = true;
                js.src = "https://connect.facebook.net/en_US/all.js";
                d.getElementsByTagName('head')[0].appendChild(js);
            }(document));

            // http://stackoverflow.com/questions/19269545/how-to-get-n-no-elements-randomly-from-an-array
            function getRandom(arr, n) {
                var result = new Array(n),
                    len = arr.length,
                    taken = new Array(len);
                if (n > len)
                    throw new RangeError("getRandom: more elements taken than available");
                while (n--) {
                    var x = Math.floor(Math.random() * len);
                    result[n] = arr[x in taken ? taken[x] : x];
                    taken[x] = --len;
                }
                return result;
            }

            function makeImage(src, height, width) {
                var newImg = new Image(height, width);
                newImg.src = src;
                return newImg;
            }

            function checkLogin () {
                if (!accessToken) {
                    FB.getLoginStatus(function(response) {
                        if (response.status === 'connected') {
                            accessToken = response.authResponse.accessToken;
                            receivedToken.resolve(accessToken);
                        }
                    })
                }
            }

            /**
            * This is the getPhoto library
            */
            function makeFacebookPhotoURL( id, accessToken ) {
                return 'https://graph.facebook.com/' + id + '/picture?access_token=' + accessToken;
            }
            function getAlbums( callback ) {
                FB.api(
                    '/me/albums',
                    {fields: 'id,cover_photo'},
                    function(albumResponse) {
                        //console.log( ' got albums ' );
                        if (callback) {
                            callback(albumResponse);
                        }
                    }
                );
            }
            function getPhotosForAlbumId( albumId, callback ) {
                FB.api(
                    '/'+albumId+'/photos',
                    {fields: 'id'},
                    function(albumPhotosResponse) {
                        //console.log( ' got photos for album ' + albumId );
                        if (callback) {
                            callback( albumId, albumPhotosResponse );
                        }
                    }
                );
            }
            function getLikesForPhotoId( photoId, callback ) {
                FB.api(
                    '/'+albumId+'/photos/'+photoId+'/likes',
                    {},
                    function(photoLikesResponse) {
                        if (callback) {
                            callback( photoId, photoLikesResponse );
                        }
                    }
                );
            }
            function getPhotos(callback) {
                var allPhotos = [];
                getAlbums(function(albumResponse) {
                    var i, album, deferreds = {}, listOfDeferreds = [];
                    for (i = 0; i < albumResponse.data.length; i++) {
                        album = albumResponse.data[i];
                        deferreds[album.id] = $.Deferred();
                        listOfDeferreds.push( deferreds[album.id] );
                        getPhotosForAlbumId( album.id, function( albumId, albumPhotosResponse ) {
                            var i, facebookPhoto;
                            for (i = 0; i < albumPhotosResponse.data.length; i++) {
                                facebookPhoto = albumPhotosResponse.data[i];
                                allPhotos.push(makeFacebookPhotoURL( facebookPhoto.id, accessToken ));
                            }
                            deferreds[albumId].resolve();
                        });
                    }
                    $.when.apply($, listOfDeferreds ).then( function() {
                        if (callback) {
                            callback( allPhotos );
                        }
                    }, function( error ) {
                        if (callback) {
                            callback( allPhotos, error );
                        }
                    });
                });
            }
        </script>
    </body>
</html>
